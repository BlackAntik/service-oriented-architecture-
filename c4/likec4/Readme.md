# Общее

Здесь дано общее описание без инфраструктурных компонентов, такие как базы данных, очереди запросов и т.д. Их я просто представлю на схеме

# Домены

### User Management

Этот домен отвечает на запросы любой информации по конкретному пользователю. В частности в него входят:

- сервис аутентификации (владеет значениями логин хеш пароля, выдаёт токены доступа к информации)
- сервис хранения личной информации (владеет всей персональной информацией пользователя)
- сервис хранения истории заказов (владеет историями заказов каждого клиента. Хранит ссылки на объявления и какие-то вспомогательные данные типа таймстемпа)

Разбил на такие сервисы потому что выполняют непересекающиеся задачи. Каждый сервис в этом домене проверяет токен запроса, прежде чем выдать доступ к информации (таким образом пользователи не смогут смотреть чужую историю заказов)

### Advertisment Management

Этот домен отвечает за все объявления (и соответственно товары, поскольку у меня не существует сущности товар без объявления). В него входят сервисы:

- сервис объявлений (владеет характеристиками товаров и контактами продавцов (в минимальном виде - имя, фамилия, ссылка на профиль))
- сервис реакций (владеет количествами просмотров и лайков)

Я выделил сервис реакций в отдельное место потому что это информация, которая занимает мало места и очень часто обновляется, ей нужна отдельная структура хранения. Сервис объявлений так же проверяет токен доступа для редактирования информации

### Recommendations 

Этот домен отвечает за предоставление рекомендаций для конкретного пользователя на основе его персональной информации, истории его заказов и общих трендов. В него входит только сервис рекомендаций, который подписан на события создания нового объявление и закрытия старого, хранит соответствующую информацию

### Orders

Этот домен отвечает за оформление заказа пользователем, в него входят

- сервис оформления заказа (хранит информацию о всех проводящихся заказах на сайте и проверяет, что нет конфликтов, 2 покупателя не оплачивают 1 и тот же товар). 
- сервис оплаты (хранит информацию о транзакциях)

Выделил сервис оплаты потому что он выполняет отдельную логическую функцию

### Notifications

Этот домен отвечает за рассылку уведомлений пользователям по разным каналам связи. Он состоит из одного сервиса уведомлений

# Межсервисные взаимодействия

Все взаимодействия про которые не написано, что они синхронные являются ассинхронными

Когда пользователь нажимает что-то на сайте (в приложении) запрос идёт в API Gateway, который распределяет на сервисы в зависимости от их содержания.

В начале сессии запрос идёт в сервис аутентификации (синхронное взаимодействие, без него нельзя продолжать работу) и получает токен, по которому потом подтверждает доступ к данным

Теперь посмотрим флоу обработки разных сценариев:

### Пользователь хочет посмотреть рекомендации

запрос отправляется в сервис рекомендаций, который идёт за историей заказов пользователя (синхронно). Дальше из объявлений, которые обновляются в фоне, составляет рекомендацию

### Продавец размещает новое объявление (либо редактирует старое)

Запрос идёт в сервис объявлений, который добавляет новое объявление, после чего идёт в сервис истории заказов, добавляя соответствующую информацию продавцу

### Пользователь делает заказ

Запрос идёт в сервис заказов. Тот проверяет, доступен ли этот товар ещё (не оплачивает ли кто-то из юзеров его уже). После идёт в сервис оплаты, где происходит оплата (синхронно). Если оплата проходит, то затем сервис заказов идёт в сервис уведомлений

### Модератор удаляет пост

Обрабатывается так же, как продавец, только у модератора особые права

# Альтернативная архитектура

Ещё у меня был вариант, где все запросы на доступ к данным проходят через Auth сервис, однако я отказался от него потому что это был бы bottleneck системы без которого бы всё не работало. Также изначально был вариант, где рекомендации не обладают никакими данными об объявлениях и ходят за ними запросами, но тогда по сети приходилось бы передавать слишком большие данные разом